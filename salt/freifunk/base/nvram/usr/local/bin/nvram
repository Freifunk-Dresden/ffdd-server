#!/usr/bin/env bash
### This file managed by Salt, do not edit by hand! ###

CONFIG_FILE='/etc/nvram.conf'

case "$1" in
	show)
		cat "$CONFIG_FILE"
	;;

	get)
		sed -n "/^$2=/{s#^.*=##;p}" "$CONFIG_FILE"
	;;

	set) # use '#' as separator, because when value contains '/'
		# command will fail
		if [ -z "$(sed -n /^"$2="/p "$CONFIG_FILE")" ]; then
			echo "${2}=${3}" >> "$CONFIG_FILE"
		else
			sed -i "s#${2}=.*#${2}=${3}#" "$CONFIG_FILE"
		fi
	;;

	unset)
		sed -i "s#${2}=.*#${2}=#" "$CONFIG_FILE"
	;;

	version)
		version=$(grep -oP '(?<=^#version=).+' "$(nvram get install_dir)"/init_server.sh | tr -d '"')
		fix=$(grep -oP '(?<=^#fix=).+' "$(nvram get install_dir)"/init_server.sh | tr -d '"')
		branch=$(nvram get branch)
		[[ -n "$fix" ]] && printf '%s_fix%s - Branch: %s\n' "$version" "$fix" "$branch" || printf '%s - Branch: %s\n' "$version" "$branch"
	;;

	*)
		printf 'usage: nvram [get name] [set name value] [unset name] [show] [version]\n';
		exit 0
	;;
esac
