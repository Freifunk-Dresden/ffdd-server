#!/usr/bin/env bash
### This file managed by Salt, do not edit by hand! ###
# check Autoupdate every day (Salt managed)
# used by: /etc/cron.d/freifunk-autoupdate
install_dir="$(nvram get install_dir)"
branch="$(nvram get branch)"

#kill running instance
mypid="$$"
pname="${0##*/}"
IFS=' '
printf '%s pid: %s\n\n' "$pname" "$mypid"
for i in $(pidof "$pname")
do
	test "$i" != "$mypid" && printf 'kill %s\n' "$i" && kill -9 "$i"
done


if [ "$(nvram get autoupdate)" -eq 1 ]; then
	# check connection before remove install_dir
	PING_CMD="ping -w 10 -c 3 github.com > /dev/null 2>&1"
	eval "$PING_CMD"

	if [ "$?" -ne 0 ]; then
		# wait for internet connection
		c='0'
		while true; do
			eval "$PING_CMD"

			if [ "$?" -eq 0 ]; then
				break
			else
				c="$((c+1))"
				[ "$c" -lt '100' ] && sleep 1 || printf 'no internet connection!\n' ; exit 0
				fi
			fi
		done
	fi

	rm -rf "$install_dir"

	git clone https://github.com/Freifunk-Dresden/ffdd-server "$install_dir"
	cd "$install_dir"

	git checkout "$branch"
	git pull origin "$branch"

	salt-call state.highstate --local

else
	printf 'Auto-Update is deactivated in /etc/nvram.conf!\n'
	exit 0;
fi
