#!/usr/bin/env bash
### This file managed by Salt, do not edit by hand! ###
# check Autoupdate every day (Salt managed)
# used by: /etc/cron.d/freifunk-autoupdate.conf
install_dir="$(nvram get install_dir)"
branch="$(nvram get branch)"

#kill running instance
mypid="$$"
pname="${0##*/}"
IFS=' '
printf '%s pid: %s\n\n' "$pname" "$mypid"
for i in $(pidof "$pname")
do
	test "$i" != "$mypid" && printf 'kill %s\n' "$i" && kill -9 "$i"
done


if [ "$(nvram get autoupdate)" -eq 1 ]; then
	# check connection before remove install_dir
	PING_CMD="ping -t 30 -c 1 github.com > /dev/null 2>&1"
	eval "$PING_CMD"

	if [[ "$?" -eq 0 ]]; then
		rm -rf "$install_dir"
	else
		# wait for internet connection
		while true; do
			eval "$PING_CMD"

			if [[ "$?" -eq 0 ]]; then
				rm -rf "$install_dir"
				break
			else
				sleep 3
			fi
		done
	fi

	git clone https://github.com/cremesk/ffdd-server.git "$install_dir"
	cd "$install_dir"

	git checkout "$branch"
	git pull origin "$branch"

	salt-call state.highstate --local
else
	exit 0;
fi
