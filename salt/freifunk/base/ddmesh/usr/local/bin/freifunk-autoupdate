#!/usr/bin/env bash
# check Autoupdate every day (Salt managed)
# used by: /etc/cron.d/freifunk-autoupdate.conf
install_dir="$(nvram get install_dir)"
version="$(nvram version)"

branch=$(sed -n "/^branch/{s#^.*=##;p}" "$install_dir"/init_server.sh | cut -d'"' -f2)
fix=$(sed -n "/^fix/{s#^.*=##;p}" "$install_dir"/init_server.sh | cut -d'"' -f2)


if [ "$(nvram get autoupdate)" -eq 1 ]; then
	if [ ! -d "$install_dir" ]; then
		git clone https://github.com/cremesk/ffdd-server.git "$install_dir"
	fi
	cd "$install_dir"

	if [ "$(nvram get release)" == 'stable' ]; then
		tag="T_RELEASE"
	else
		tag="T_TESTING"
	fi

	git pull origin master
	git checkout "$branch""_v""$version"
	git pull origin "$tag""_v""$version""$fix"

	salt-call state.highstate --local
else
	exit 0;
fi
