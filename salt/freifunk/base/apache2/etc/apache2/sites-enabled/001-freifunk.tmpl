### This file managed by Salt, do not edit by hand! ###
{% set nodeid = salt['cmd.shell']('/usr/local/bin/nvram get ddmesh_node') %}
{% set nodeip = salt['cmd.shell']("ip addr show bmx_prime | grep inet | awk '/inet/ {print $2}' | sed 's/\/.*//'") %}
{% set vpnid = salt['cmd.shell']("grep -R $(nvram get fastd_public) /etc/fastd/peers2 | egrep -o 'vpn[0-9]+'") %}
#NameVirtualHost *:80
#local virtual server: info / node page
<VirtualHost *:80>
	ServerName {{ nodeid }}.freifunk-dresden.de
	{% if vpnid != '' %}
	ServerAlias {{ vpnid }}.freifunk-dresden.de
	{% endif %}
	ServerAlias {{ nodeip }}.freifunk-dresden.de
	ServerAlias {{ nodeip }}
#	ServerAdmin webmaster@localhost

	# redirect if not found, to avoid displaying other internal stuff
	ErrorDocument 404 /

	DocumentRoot /var/www_freifunk
	<Directory /var/www_freifunk>
		AllowOverride None
		AddHandler cgi-script .cgi
		AddHandler cgi-script .json
		Options -Indexes +ExecCGI +MultiViews +FollowSymLinks +Includes
		Require all granted
	</Directory>

	CustomLog /var/log/apache2/freifunk_access.log combined
	ErrorLog /var/log/apache2/freifunk_error.log

	# Possible values include: debug, info, notice, warn, error, crit, alert, emerg.
	LogLevel warn

	include /etc/apache2/conf-enabled/letsencrypt.conf
	include /etc/apache2/conf-enabled/monitorix.conf

</VirtualHost>
