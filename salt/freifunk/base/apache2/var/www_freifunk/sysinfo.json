#!/bin/sh

echo 'Content-Type: application/json;charset=UTF-8'
echo ''


BMXD_DB_PATH='/var/lib/freifunk/bmxd'

ddmesh_node="$(nvram get ddmesh_node)"
test -z "$ddmesh_node" && exit

eval "$(ddmesh-ipcalc.sh -n "$ddmesh_node")"

wan_device="$(nvram get ifname)"
wifi_device=$(l=$(grep : /proc/net/wireless);l=${l%:*};echo ${l##* })
wifi2_device=''
vpn='vpn0'
gwt='bat0'

#"version":"$(sed -n '/^#version/{s#^.* ##;p}' "$(nvram get install_dir)/init_server.sh")",

cat << EOM
{
 "version":"10",
 "timestamp":"$(date +'%s')",
 "data":{

EOM

#node info
cat << EOM
		"firmware":{
			"version":"",
			"DISTRIB_ID":"$(lsb_release -si)",
			"DISTRIB_RELEASE":"$(lsb_release -sr)",
			"DISTRIB_REVISION":"",
			"DISTRIB_CODENAME":"$(lsb_release -sc)",
			"DISTRIB_TARGET":"$(uname -m)",
			"DISTRIB_DESCRIPTION":"$(lsb_release -sd)"
		},
		"system":{
			"uptime":"$(uptime)",
			"uname":"$(uname -a)",
			"nameserver": [
$(cat /etc/resolv.conf | sed -n '/nameserver[ 	]\+10\.200/{s#[ 	]*nameserver[ 	]*\(.*\)#\t\t\t\t"\1",#;p}' | sed '$s#,##')
			],
			"date":"$(date)",
			"board":"",
			"model":"",
			"model2":"",
			"cpuinfo":"$(cat /proc/cpuinfo | grep -m1 'model name' | sed -n '/^model/{s#^.*:##;p}')",
			"bmxd" : "$(cat $BMXD_DB_PATH/status)",
			"autoupdate":"$(nvram get autoupdate)"
		},
		"common":{
			"city":"$(nvram get city)",
			"node":"$_ddmesh_node",
			"domain":"$_ddmesh_domain",
			"ip":"$_ddmesh_ip",
			"fastd_pubkey":"$(/etc/init.d/S53backbone-fastd2 get_public_key)"
		},
		"gps":{
			"latitude":"$(nvram get gps_latitude)",
			"longitude":"$(nvram get gps_longitude)",
			"altitude":"$(nvram get gps_altitude)"
		},
		"contact":{
			"name":"$(nvram get contact_name)",
			"location":"$(nvram get contact_location)",
			"email":"$(nvram get contact_email)",
			"note":"$(nvram get contact_note)"
		},
		"backbone":{
			"accept":[
EOM
			IFS='
'
			for i in $(nvram show 2>/dev/null | grep "^backbone_range_[0-9]" | sed 's#^.*=##')
			do
				IFS=' :'; set $i
				start=$1
				count=$2
				end=$(($start+$count-1))
				echo "				{\"first\":\"$start\",\"last\":\"$end\"},"
			done 
			IFS='
'
			for i in $(nvram show 2>/dev/null | grep "^backbone_accept_[0-9]" | sed 's#^.*=##')
			do
				IFS=' :'; set $i
				echo "				{\"first\":\"$1\",\"last\":\"$1\"},"
			done 
			echo "				{\"first\":\"\",\"last\":\"\"}"
			#reset IFS
			IFS='
'

cat << EOM
			]
		},
EOM

cat<<EOM
		"statistic" : {
			"accepted_user_count" : "0",
			"dhcp_count" : "0",
			"dhcp_lease" : "0",
EOM

			rx=$(sudo /sbin/iptables -w -xvn -L stat_from_ovpn | awk '/RETURN/{print $2}')
			tx=$(sudo /sbin/iptables -w -xvn -L stat_to_ovpn | awk '/RETURN/{print $2}')
			echo "				\"traffic_ovpn\" : \"$rx,$tx\"," 

			# fastd kann nicht via firewall rules geazhlt werden, da ich hier nicht zwischen rx/tx unterscheiden kann
			# Also hier fuer die server, das interface befragen
			for iface in $(cat /proc/net/dev | sed -n '3,${s#^[	 ]*\([^:]\+\).*#\1#p}')
			do
				if [ "$iface" = "tbb_fastd2" ]; then
					iface_alias="tbb_fastd"
					echo "		\"traffic_$iface_alias\": \"$(cat /proc/net/dev | grep $iface: | sed -n 's#.*:[ ]*\([0-9]\+\)\([ ]\+\([0-9]\+\)\)\{8\}.*#\1,\3#;p')\","
				fi
			done

cat<<EOM
$(cat /proc/meminfo | sed 's#\(.*\):[ 	]\+\([0-9]\+\)[ 	]*\(.*\)#\t\t\t\"meminfo_\1\" : \"\2\ \3\",#')
			"cpu_load" : "$(cat /proc/loadavg)",
			"cpu_stat" : "$(cat /proc/stat | sed -n '/^cpu[ 	]\+/{s# \+# #;p}')",
			"gateway_usage" : []
		},
EOM

#bmxd
#$(ip route list table bat_route | sed 's#\(.*\)#			"\1",#; $s#,[ 	]*$##') ],
cat<<EOM
		"bmxd":{
			"routing_tables":{
				"route":{
					"link":[
$(ip route list table bat_route | sed -n '/scope[ ]\+link/{s#^\([0-9./]\+\)[	 ]\+dev[	 ]\+\([^	 ]\+\).*#\t\t\t\t\t\t{"target":"\1","interface":"\2"},#;p}' | sed '$s#,[ 	]*$##') ]
				},
				"hna":{
					"link":[
$(ip route list table bat_hna | sed -n '/scope[ ]\+link/{s#^\([0-9./]\+\)[	 ]\+dev[	 ]\+\([^	 ]\+\).*#\t\t\t\t\t\t{"target":"\1","interface":"\2"},#;p}' | sed '$s#,[ 	]*$##') ],
				"global":[
$(ip route list table bat_hna | sed -n '/scope[ ]\+link/d;s#^\([0-9./]\+\)[	 ]\+via[	 ]\+\([0-9.]\+\)[	 ]\+dev[	 ]\+\([^	 ]\+\).*#\t\t\t\t\t\t{"target":"\1","via":"\2","interface":"\3"},#p' | sed '$s#,[ 	]*$##') ]
				}
			},
			"gateways":{
				"selected":"$(cat $BMXD_DB_PATH/gateways | sed -n 's#^[	 ]*=>[	 ]\+\([0-9.]\+\).*$#\1#p')",
				"preferred":"$(cat $BMXD_DB_PATH/gateways | sed -n '1,1s#^.*preferred gateway:[	 ]\+\([0-9.]\+\).*$#\1#p')",
				"gateways":[
$(cat $BMXD_DB_PATH/gateways | sed -n '
				/^[	 ]*$/d
				1,1d
				s#^[	 =>]*\([0-9.]\+\).*$#\t\t\t\t{"ip":"\1"},#p
				' | sed '$s#,[	 ]*$##') ]
			},
			"info":[
$(cat $BMXD_DB_PATH/info | sed 's#^[ 	]*\(.*\)$#\t\t\t\t"\1",#; $s#,[ 	]*$##') ]
		},
		"connections":[
EOM
netstat -tn 2>/dev/null | grep ESTABLISHED | awk '
	{
		split($4,a,":");
		split($5,b,":");
		if(match(a[1],"169.254")) a[1]=ENVIRON["_ddmesh_ip"]
		#allow display node ip
		if(a[1] == ENVIRON["_ddmesh_ip"])
		{
			printf("\t\t\t{\"local\":{\"ip\":\"%s\",\"port\":\"%s\"},\"foreign\":{\"ip\":\"%s\",\"port\":\"%s\"}},\n",a[1],a[2],b[1],b[2]);
		}
	}' | sed '$s#,[ 	]*$##'
cat << EOM
		]
EOM

# remove last comma
#$s#,[ 	]*$##

cat << EOM
  }
}
EOM


